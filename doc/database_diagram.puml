@startuml Database ER Diagram - Simplified Payment API

' Entidades principais baseadas nas regras de negócio e plano de desenvolvimento

entity User {
  * id : BIGINT AUTO_INCREMENT
  --
  name : VARCHAR(255) NOT NULL
  cpf_cnpj : VARCHAR(20) UNIQUE NOT NULL
  email : VARCHAR(255) UNIQUE NOT NULL
  password : VARCHAR(255) NOT NULL
  type : ENUM('user', 'shopkeeper') NOT NULL
  balance : DECIMAL(15,2) DEFAULT 0.00
  created_at : TIMESTAMP DEFAULT CURRENT_TIMESTAMP
  updated_at : TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
}

entity Transaction {
  * id : BIGINT AUTO_INCREMENT
  --
  payer_id : BIGINT NOT NULL
  payee_id : BIGINT NOT NULL
  value : DECIMAL(15,2) NOT NULL
  status : ENUM('pending', 'approved', 'rejected', 'failed') DEFAULT 'pending'
  correlation_id : VARCHAR(255) UNIQUE ' Para idempotência
  created_at : TIMESTAMP DEFAULT CURRENT_TIMESTAMP
  updated_at : TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
}

entity Notification {
  * id : BIGINT AUTO_INCREMENT
  --
  transaction_id : BIGINT NOT NULL
  user_id : BIGINT NOT NULL
  type : ENUM('email', 'sms') NOT NULL
  status : ENUM('queued', 'sent', 'failed') DEFAULT 'queued'
  message : TEXT
  sent_at : TIMESTAMP NULL
  created_at : TIMESTAMP DEFAULT CURRENT_TIMESTAMP
}

entity AuditLog {
  * id : BIGINT AUTO_INCREMENT
  --
  user_id : BIGINT NULL
  transaction_id : BIGINT NULL
  action : VARCHAR(255) NOT NULL
  details : JSON
  ip_address : VARCHAR(45)
  user_agent : TEXT
  timestamp : TIMESTAMP DEFAULT CURRENT_TIMESTAMP
}

entity TransferEvent {
  * _id : ObjectId
  --
  transfer_id : String (correlation_id)
  event_type : String (e.g., 'TransferInitiated')
  user_id : BIGINT
  event_data : JSON
  timestamp : TIMESTAMP
}

entity NotificationLog {
  * _id : ObjectId
  --
  transfer_id : String
  user_id : BIGINT
  type : String (email/sms)
  status : String (sent/failed)
  response : JSON
  attempts : INT
  timestamp : TIMESTAMP
}

' Relacionamentos MongoDB (não relacionais, mas indicativos)
Transaction ||--o{ TransferEvent : "generates"
Transaction ||--o{ NotificationLog : "logs notifications"

note right of TransferEvent : MongoDB Collection: transfer_events\nAppend-only, TTL 1 year
note right of NotificationLog : MongoDB Collection: notification_logs\nAppend-only, TTL 30 days

' Índices sugeridos (não visuais, mas anotados)
note right of User : Índices: cpf_cnpj, email, type
note right of Transaction : Índices: payer_id, payee_id, status, correlation_id
note right of Notification : Índices: transaction_id, user_id, status
note right of AuditLog : Índices: user_id, transaction_id, action, timestamp
note right of TransferEvent : Índices: transfer_id, event_type, user_id, timestamp

@enduml