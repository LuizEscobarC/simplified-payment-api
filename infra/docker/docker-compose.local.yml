services:
    payment-nginx:
        container_name: payment-nginx
        image: nginx:alpine
        restart: unless-stopped
        ports:
            - "80:80"
            - "443:443"
        logging:
            driver: "json-file"
            options:
                max-size: "10m"
                max-file: "3"
        volumes:
            - ../../api:/var/www/html
            - ./nginx/${NGINX_CONF_FILE:-local.conf}:/etc/nginx/conf.d/default.conf
        command: "/bin/sh -c 'while :; do sleep 6h & wait $${!}; nginx -s reload; done & nginx -g \"daemon off;\"'"
        networks:
            - payment_network

    app:
        container_name: backend-api
        image: payment-laravel:latest
        restart: unless-stopped
        environment:
            DB_CONNECTION: ${DB_CONNECTION}
            DB_HOST: ${DB_HOST}
            DB_DATABASE: ${DB_DATABASE}
            DB_USERNAME: ${DB_USERNAME}
            DB_PASSWORD: ${DB_PASSWORD}
            DB_DADOS_CONNECTION: ${DB_DADOS_CONNECTION}
            DB_DADOS_HOST: ${DB_DADOS_HOST}
            DB_DADOS_DATABASE: ${DB_DADOS_DATABASE}
            DB_DADOS_USERNAME: ${DB_DADOS_USERNAME}
            DB_DADOS_PASSWORD: ${DB_DADOS_PASSWORD}
        working_dir: /var/www/
        command: ["/var/www/entrypoint.sh"]
        logging:
            driver: "json-file"
            options:
                max-size: "10m"
                max-file: "3"
        volumes:
            # =================================================================================
            # VOLUMES PARA CONFIGURAÇÕES DE TIMEOUT
            # =================================================================================
            # 
            # ALTERAÇÕES IMPLEMENTADAS:
            # 1. Volume para configuração PHP customizada (local.ini)
            #    - Contém configurações de timeout e memória
            #    - memory_limit=8G, max_execution_time=7200s
            #
            # 2. Volume para configuração PHP-FPM customizada (www.conf)
            #    - Contém configurações de pool e timeout do FPM
            #    - request_terminate_timeout=7200s, pool otimizado
            #
            # MOTIVO DAS ALTERAÇÕES:
            # - Resolver 504 Gateway Timeout em endpoints pesados
            # - Suporte a consultas longas no InfluxDB
            # - Processamento de grandes volumes de dados
            #
            # =================================================================================
            - ../../api/:/var/www/html
            - ./php/${INI_FILE:-local.ini}:/usr/local/etc/php/conf.d/local.ini
            - ./php/www.conf:/usr/local/etc/php-fpm.d/www.conf
            - ./entrypoint.sh:/var/www/entrypoint.sh
        networks:
            - et-backend_laravel

    supervisor:
        image: neobackend-supervisor:latest
        profiles:
            - production
        
        container_name: et-supervisor
        restart: unless-stopped
        command: ["/usr/bin/supervisord", "-n", "-c",  "/etc/supervisor/supervisord.conf"]
        environment:
            APP_ROOT: ${APP_ROOT}
            QUEUE_DRIVER: ${QUEUE_CONNECTION}
            OPTIONS: ${QUEUE_OPTIONS}
            DB_CONNECTION: ${DB_CONNECTION}
            DB_HOST: ${DB_HOST}
            DB_DATABASE: ${DB_DATABASE}
            DB_USERNAME: ${DB_USERNAME}
            DB_PASSWORD: ${DB_PASSWORD}
            DB_DADOS_CONNECTION: ${DB_DADOS_CONNECTION}
            DB_DADOS_HOST: ${DB_DADOS_HOST}
            DB_DADOS_DATABASE: ${DB_DADOS_DATABASE}
            DB_DADOS_USERNAME: ${DB_DADOS_USERNAME}
            DB_DADOS_PASSWORD: ${DB_DADOS_PASSWORD}
        logging:
            driver: "json-file"
            options:
                max-size: "10m"
                max-file: "3"
        volumes:
            # =================================================================================
            # VOLUMES PARA SUPERVISOR - CONFIGURAÇÕES DE TIMEOUT
            # =================================================================================
            # 
            # ALTERAÇÕES IMPLEMENTADAS:
            # 1. Volume para configuração PHP customizada (local.ini)
            #    - Mesmo arquivo usado no serviço app
            #    - Garante consistência entre serviços
            #
            # 2. Volume para configuração PHP-FPM customizada (www.conf)
            #    - Mesmo arquivo usado no serviço app
            #    - Pool de workers otimizado para produção
            #
            # IMPORTANTE:
            # - Supervisor service usa as mesmas configurações
            # - Garante que workers em background também tenham timeouts adequados
            # - Consistência entre desenvolvimento e produção
            #
            # =================================================================================
            - ../../api/:/var/www/html
            - ./supervisor/supervisor.conf:/etc/supervisor/supervisord.conf
            - ./php/${INI_FILE}:/usr/local/etc/php/conf.d/local.ini
            - ./php/www.conf:/usr/local/etc/php-fpm.d/www.conf
        networks:
            - et-backend_laravel


networks:
    payment_network:
        external: true