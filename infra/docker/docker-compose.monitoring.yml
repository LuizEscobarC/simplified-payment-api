services:
    elasticsearch:
        container_name: payment-elasticsearch
        image: elasticsearch:8.11.4
        restart: unless-stopped
        ports:
            - "9200:9200"
            - "9300:9300"
        environment:
            - discovery.type=single-node
            - xpack.security.enabled=false
            - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
        volumes:
            - elasticsearch_data:/usr/share/elasticsearch/data
        networks:
            - payment-api-monitoring
        healthcheck:
            test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
            interval: 30s
            timeout: 10s
            retries: 3

    logstash:
        container_name: payment-logstash
        image: logstash:8.11.4
        restart: unless-stopped
        ports:
            - "5044:5044"
            - "5000:5000"
            - "9600:9600"
        volumes:
            - ./monitoring/logstash.conf:/usr/share/logstash/pipeline/logstash.conf
            - ./monitoring/logstash.yml:/usr/share/logstash/config/logstash.yml
        networks:
            - payment-api-monitoring
        depends_on:
            elasticsearch:
                condition: service_healthy

    kibana:
        container_name: payment-kibana
        image: kibana:8.11.4
        restart: unless-stopped
        ports:
            - "5601:5601"
        environment:
            - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
        networks:
            - payment-api-monitoring
        depends_on:
            elasticsearch:
                condition: service_healthy
        healthcheck:
            test: ["CMD-SHELL", "curl -f http://localhost:5601/api/status || exit 1"]
            interval: 30s
            timeout: 10s
            retries: 3

    prometheus:
        container_name: payment-prometheus
        image: prom/prometheus:latest
        restart: unless-stopped
        ports:
            - "9090:9090"
        volumes:
            - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
            - prometheus_data:/prometheus
        command:
            - '--config.file=/etc/prometheus/prometheus.yml'
            - '--storage.tsdb.path=/prometheus'
            - '--web.console.libraries=/etc/prometheus/console_libraries'
            - '--web.console.templates=/etc/prometheus/consoles'
            - '--storage.tsdb.retention.time=200h'
            - '--web.enable-lifecycle'
        networks:
            - payment-api-monitoring

volumes:
    elasticsearch_data:
    prometheus_data:

networks:
    payment-api-monitoring:
        external: true