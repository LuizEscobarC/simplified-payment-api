#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "üîç Executando verifica√ß√µes de qualidade de c√≥digo..."

# Function to run command
run_command() {
    local cmd="$1"
    if [ -f /var/www/html/composer.json ]; then
        eval "$cmd"
    else
        if docker ps | grep -q payment-api; then
            docker exec payment-api sh -c "cd /var/www/html && $cmd"
        else
            cd api && eval "$cmd"
        fi
    fi
}

# Laravel Pint
echo "üé® Executando Laravel Pint..."
run_command "./vendor/bin/pint --test" || {
    echo "‚ùå Laravel Pint encontrou problemas. Corrigindo..."
    run_command "./vendor/bin/pint"
    git add .
}

# PHPMD
echo "üìä Executando PHPMD..."
if [ -f /var/www/html/composer.json ]; then
    /usr/local/bin/phpmd app xml phpmd.xml || {
        echo "‚ö†Ô∏è PHPMD encontrou problemas. Revise o c√≥digo."
        exit 1
    }
else
    if docker ps | grep -q payment-api; then
        docker exec payment-api sh -c "cd /var/www/html && /usr/local/bin/phpmd app xml phpmd.xml" || {
            echo "‚ö†Ô∏è PHPMD encontrou problemas. Revise o c√≥digo."
            exit 1
        }
    else
        infra/tools/phpmd api/app xml phpmd.xml || {
            echo "‚ö†Ô∏è PHPMD encontrou problemas. Revise o c√≥digo."
            exit 1
        }
    fi
fi

echo "‚úÖ Verifica√ß√µes de qualidade conclu√≠das!"
